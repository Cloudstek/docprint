{% import 'macros.njk' as macros %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>{{ title }} API</title>

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Source+Code+Pro">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css">
        <style type="text/css">
            {{ css | safe }}
        </style>
    </head>
    <body>
        {% if header %}
            {{ header | safe }}
        {% else %}
            <header>
                <h1>{{ title }} <spanl>API</span></h1>
            </header>
        {% endif %}

        <div class="documentation">
            <div class="top-header">
                <div class="lang-header part-header">
                    {#
                    <ul>
                        {% for lang in languages %}
                            <li data-lang="{{ lang.hljs }}">{{ lang.name }}</li>
                        {% endfor %}
                    </ul>#}
                    {% for lang in languages %}
                        <span class="lan" data-lang="{{ lang.jljs }}">{{ lang.displayName }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="sidebar">
                <nav class="sidebar-nav">
                    {# Overview #}
                    <div class="group-header">
                        <a href="#overview">Overview</a>
                    </div>

                    {# Navigation #}
                    {% for group in doc.content[0].content %}
                        {% if group.title %}
                            <div class="group-header">
                                <a href="#{{ group.id }}">{{ group.title }}</a>
                            </div>
                        {% endif %}
                        <ul>
                            {# Resources #}
                            {% for resource in group.content %}
                                <li class="resource-header">
                                    <a href="#{{ resource.id }}" class="resource-nav-item">{{ resource.title }}</a>
                                    <ul>
                                        {# Transitions (actions) #}
                                        {% for transition in resource.content %}
                                            <li class="transition">
                                                <a href="#{{ transition.id }}" class="child-nav-item">
                                                    <span class="child-nav-text">{{ transition.title }}</span>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endfor %}
                </nav>
            </div>

            <div class="container">
                <div class="doc-body col-12">
                    {# Overview #}
                    <div class="row">
                        <div class="col-6 lhs">
                            <div class="group-heading top" id="overview">{{ doc.content[0].title | capitalize }}</div>
                            {% if doc.content[0].description %}
                                <div class="description">{{ doc.content[0].description.text | safe }}</div>
                            {% endif %}
                        </div>
                    </div>

                    {# Resource groups #}
                    {% for group in doc.content[0].content %}
                        <div class="row">
                            <div class="col-6 lhs">
                                <div class="group-heading way-point" id="{{ group.id }}">{{ group.title }}</div>
                                {% if group.description %}
                                    <div class="description">{{ group.description.text | safe }}</div>
                                {% endif %}
                            </div>
                            <div class="col-6 rhs"></div>
                        </div>

                        {# Resources #}
                        {% for resource in group.content %}
                            <div class="row">
                                <div class="col-6 lhs">
                                    <div class="resource-heading way-point" id="{{ resource.id }}">{{ resource.title }}</div>
                                    {% if resource.description.text %}
                                        <div class="description">{{ resource.description.text | safe }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-6 rhs"></div>
                            </div>

                            {# Transitions (actions) #}
                            {% for transition in resource.content %}
                                {% if transition.type === 'transition' %}
                                    <div class="row">
                                        {# Left #}
                                        <div class="col-6 lhs">
                                            <div class="transition-heading way-point" id="{{ transition.id }}">{{ transition.title }}</div>
                                            {% if transition.description %}
                                                <div class="description">{{ transition.description.text | safe }}</div>
                                            {% endif %}
                                            {% if transition.xhrContent.urlParameters.length %}
                                                <h5 class="part-heading">URL Parameters</h5>
                                                {{ macros.renderUrlParameters(transition.xhrContent.urlParameters) }}
                                            {% endif %}
                                            {% if transition.xhrContent.attributes.length %}
                                                <h5 class="part-heading">Attributes</h5>
                                                {{ macros.renderAttributes(transition.xhrContent.attributes, dataStructures) }}
                                            {% endif %}
                                        </div>

                                        {# Right #}
                                        <div class="col-6 rhs">
                                            {# Definition #}
                                            <div class="api-definition">
                                                <div class="api-definition-heading rhs-heading">Definition</div>
                                                <div class="api-definition-description rhs-highlight code">
                                                    <div class="hljs">
                                                        <span class="hljs-attribute">{{ transition.xhrContent.method }}</span> {{ transition.xhrContent.originalUrl }}
                                                    </div>
                                                </div>
                                            </div>

                                            {# Request #}
                                            <div class="sample-request-heading rhs-heading">Request</div>

                                            {# Request Headers #}
                                            {% if transition.xhrContent.headers.length %}
                                                <div class="headers">
                                                    <div class="headers-heading rhs-heading">Request Headers</div>
                                                    <div class="headers-description rhs-highlight code">
                                                        <div class="hljs">
                                                            {%- for header in transition.xhrContent.headers -%}
                                                                <span class="hljs-attribute">{{ header.name }}</span>: {{ header.value }}
                                                            {%- endfor -%}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}

                                            {# Request Body #}
                                            {% for transaction in transition.content[0].content %}
                                                {% if transaction.type === 'httpRequest' and transaction.content[0].type === 'body' %}
                                                    <div class="sample-request-body rhs-heading">Request Body</div>
                                                    <div class="sample-request-body-description rhs-highlight">
                                                        <pre><code>
                                                            {{- transaction.content[0].content -}}
                                                        </code></pre>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}

                                            {# Request Example #}
                                            {% if transition.snippets %}
                                                <div class="sample-request">
                                                    <div class="sample-request-heading rhs-heading">Example Request</div>
                                                    <div class="sample-request-description rhs-highlight">
                                                        {%- for lang in languages -%}
                                                            {%- if transition.snippets[lang.name] -%}
                                                                <pre><code class="{{ lang.hljs }}">
                                                                    {{- transition.snippets[lang.name] -}}
                                                                </code></pre>
                                                            {%- endif -%}
                                                        {% endfor -%}
                                                    </div>
                                                </div>
                                            {% endif %}

                                            {# Responses #}
                                            <div class="sample-response">
                                                {% for transaction in transition.content[0].content %}
                                                    {% if transaction.type === 'httpResponse' %}
                                                        <div class="sample-response-heading rhs-heading">
                                                            <span>Response&nbsp;</span>
                                                            <span class="status-code">{{ transaction.props.statusCode }}</span>
                                                        </div>

                                                        {# Headers #}
                                                        {% if transaction.props.headers.length %}
                                                            <div class="headers">
                                                                <div class="headers-heading rhs-heading">Response Headers</div>
                                                                <div class="headers-description rhs-highlight code">
                                                                    <div class="hljs">
                                                                        {% for header in transaction.props.headers %}
                                                                            <span class="hljs-attribute">{{ header.key.content }}</span>: {{ header.value.content }} {% if not loop.last %}<br />{% endif %}
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}

                                                        {# Body #}
                                                        {% if transaction.content[0].type === 'body' %}
                                                            <div class="sample-response-body rhs-heading">Response Body</div>
                                                            <div class="sample-response-body-description rhs-highlight">
                                                                <pre><code>
                                                                    {{- transaction.content[0].content -}}
                                                                </code></pre>
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% elif transition.type === 'dataStructure' %}
                                    <div class="row">
                                        <div class="col-6 lhs">
                                            <div class="transition-heading way-point" id="{{ transition.id }}">{{ transition.title }}</div>
                                            <h5 class="part-heading">Attributes</h5>
                                            {{ macros.renderAttributes(transition.content[0], dataStructures) }}
                                        </div>
                                        <div class="col-6 rhs"></div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/noframework.waypoints.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/http.min.js"></script>
        <script type="text/javascript">
            hljs.initHighlightingOnLoad();

            function triggerEvent(el, eventName) {
                if (!el) return;
                var evt;
                try {
                    evt = new window.Event(eventName, {bubbles: true});
                }
                catch (e) {
                    evt = document.createEvent('Event');
                    evt.initEvent(eventName, true, false);
                }
                finally {
                    el.dispatchEvent(evt);
                }
            };
            var docbody = document.querySelector('.doc-body');
            docbody.addEventListener('click', function(e) {
                if (e.target.classList.contains('expand') || e.target.classList.contains('close')) {
                    var childAttr = e.target.parentNode.parentNode;
                    childAttr.classList.toggle('show');
                }
            });
            var sidebar = document.querySelector('.sidebar');
            sidebar.addEventListener('click', function(e) {
                if (e.target.classList.contains('resource-nav-item')) {
                    var selected = sidebar.querySelector('.resource-header.expand');
                    var resourceHeader = e.target.parentNode;
                    if (selected !== e.target.parentNode) {
                        selected && selected.classList.remove('expand');
                        resourceHeader.classList.add('expand');
                    }
                } else if (e.target.classList.contains('child-nav-text')) {
                    var selected = sidebar.querySelector('.child-nav-item.selected');
                    if (selected !== e.target.parentNode) {
                        selected && selected.classList.remove('selected');
                        e.target.parentNode.classList.add('selected');
                    }
                } else if (e.target && e.target.parentNode && e.target.parentNode.classList.contains('group-header')) {
                    var selected = sidebar.querySelector('.resource-header.expand');
                    selected && selected.classList.remove('expand');
                    selected = sidebar.querySelector('.child-nav-item.selected');
                    selected && selected.classList.remove('selected');
                }
            });
            var langBar = document.querySelector('.top-header .lang-header');
            langBar.addEventListener('click', function(e) {
                if (e.target.classList.contains('lan')) {
                    var selectedLang = langBar.querySelector('.selected');
                    selectedLang = selectedLang && selectedLang.getAttribute('lang')
                    var targetLang = e.target.getAttribute('lang');
                    if (window.location.pathname.indexOf('/' + selectedLang) !== -1) {
                        window.location.pathname = window.location.pathname.replace('/' + selectedLang, '/' + targetLang);
                    } else if (window.location.search.indexOf(selectedLang) !== -1) {
                        window.location.search = window.location.search.replace(selectedLang, targetLang);
                    } else {
                    }
                }
            })
            var waypoints = document.querySelectorAll('.way-point');
            function selectSection(navEl) {
                var selected;
                if (navEl) {
                    if (navEl.classList.contains('child-nav-item')) {
                        var resourceNav = navEl.parentNode.parentNode.parentNode;
                        selected = sidebar.querySelector('.child-nav-item.selected');
                        selected && (selected !== navEl) && selected.classList.remove('selected');
                        selected = sidebar.querySelector('.resource-header.expand');
                        selected && (selected !== resourceNav) && selected.classList.remove('expand');
                        resourceNav.classList.add('expand');
                        navEl.classList.add('selected');
                    } else if (navEl.classList.contains('resource-nav-item')) {
                        selected = sidebar.querySelector('.child-nav-item.selected');
                        selected && (selected !== navEl) && selected.classList.remove('selected');
                        selected = sidebar.querySelector('.resource-header.expand');
                        selected && (selected !== resourceNav) && selected.classList.remove('expand');
                        navEl.parentNode && navEl.parentNode.classList.add('expand');
                    } else {
                        selected = sidebar.querySelector('.child-nav-item.selected');
                        selected && (selected !== navEl) && selected.classList.remove('selected');
                        selected = sidebar.querySelector('.resource-header.expand');
                        selected && (selected !== resourceNav) && selected.classList.remove('expand');
                    }
                }
            }
            var wayHandler = debounce(function() {

                if (this.element.classList.contains('header-anchor')) {
                    this.element = this.element.parentNode;
                }

                var tid = this.element.id;
                var id = '#' + this.element.id;

                var navEl = document.querySelector('.sidebar a[href=\"' + id + '\"]');
                selectSection(navEl)
            }, 0, true)
            var hAnchors = document.querySelectorAll('.header-anchor');
            var topElement = document.querySelector('.top')
            for(var i = 0;i < waypoints.length; i++) {
                new Waypoint({
                    continuous: false,
                    context: document.querySelector('.container'),
                    element: waypoints[i],
                    handler: wayHandler
                });
            }
            for(var i = 0;i < hAnchors.length; i++) {
                new Waypoint({
                    continuous: false,
                    context: document.querySelector('.container'),
                    element: hAnchors[i],
                    handler: wayHandler,
                    offset: 20
                });
            }
            new Waypoint({
                continuous: false,
                context: document.querySelector('.container'),
                element: topElement,
                handler: wayHandler,
                offset: -10
            });
            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };
            var h = window.location.hash
            if (h) {
                var scrollEl = document.getElementById(h.slice(1));
                if (scrollEl) {
                    scrollEl.scrollIntoView();
                }
            }
        </script>
    </body>
</html>
